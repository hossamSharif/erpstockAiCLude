<ion-header>
  <ion-toolbar> 
    <ion-title > تعديل فاتورة مبيعات</ion-title> 
    <ion-buttons  slot="end"> 
   
    

     
    <ion-button fill="clear" (click)="back()">
      <ion-icon name="arrow-back-sharp"></ion-icon>
    </ion-button> 
    </ion-buttons> 
  
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- skeleton -->
 
  <ion-grid *ngIf="payInvo">
    <ion-row dir="rtl">
      <ion-col size="12">
        <ion-card class="ion-no-padding ion-no-margin">
          <ion-grid>
            <ion-row dir="rtl" class="top-card-row">
              <!-- First Column: Account Selector -->
              <ion-col size="3" class="account-column">
                <app-account-selector
                  accountType="customer"
                  placeholder="اختر حساب العميل"
                  label="حساب العميل"
                  [store_info]="store_info"
                  [year]="year"
                  [showAddButton]="true"
                  [(ngModel)]="selectedAccount"
                  (accountSelected)="onAccountSelected($event)"
                  (balanceLoaded)="onAccountBalanceLoaded($event)">
                </app-account-selector>
              </ion-col>
              
              <!-- Second Column: Invoice Type -->
              <ion-col size="3" class="invoice-type-column">
                <ion-label class="column-label">نوع الفاتورة</ion-label>
                <div class="invoice-type-section">
                  <ion-segment [(ngModel)]="radioVal2" (ionChange)="radioChange2($event ,'from')" class="compact-segment">
                    <ion-segment-button [value]="0">
                      <span>مبدئية</span>
                    </ion-segment-button>
                    <ion-segment-button [value]="1">
                      <span>نهائية</span>
                    </ion-segment-button>
                  </ion-segment>
                </div>
              </ion-col>
              
              
              <!-- Fourth Column: Date -->
              <ion-col size="3" class="date-column" dir="rtl">
                <ion-label class="column-label">التاريخ</ion-label>
                <ion-item class="custInput date-input">
                  <ion-input type="date" [(ngModel)]="payInvo.pay_date" placeholder="التاريخ"></ion-input>
                </ion-item>
              </ion-col>
              
              <!-- Fifth Column: Comment -->
              <ion-col size="3" class="date-comment-column">
                <ion-label class="column-label">ملاحظة</ion-label>
                <ion-item class="custInput comment-input">
                  <ion-input placeholder="أكتب تعليقا" [(ngModel)]="payInvo.payComment"></ion-input>
                </ion-item>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>
  
  <ion-grid class="ion-margin-top" *ngIf="payInvo" >
    <ion-row dir="rtl">
      <ion-col size="8" class="ion-no-padding">
        <ion-grid>
          <ion-row>
            <ion-col size="12">
              <ion-card>
                <app-item-selector
                [items]="items"
                [loadingItems]="loadingItems"
                [searchLang]="searchLang"
                [store_info]="store_info"
                [year]="year"
                parentPage="edit-sales"
                [enablePriceUpdateConfirmation]="true"
                [payRef]="payInvo.pay_ref"
                [showQuantityInput]="true"
                [showPriceInput]="true"
                [showPerchPriceInput]="false"
                placeholder="اختر الصنف"
                (itemSelected)="onItemSelected($event)"
                (itemAdded)="onItemAdded($event)"
                (refreshItems)="refresh('item')">
              </app-item-selector>
              </ion-card>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size="12">
            <ion-card>
              <ion-card-header color="primary" class="table-card-header">
                <ion-card-title>
                  <ion-row class="ion-align-items-center">
                    <ion-col size="3">
                      <span>قائمة الأصناف</span>
                    </ion-col>
                    <ion-col size="6" class="ion-text-center">
                      <div class="search-container">
                        <ion-item lines="none" class="search-item">
                          <ion-icon name="search" slot="start" color="medium"></ion-icon>
                          <ion-input
                            [(ngModel)]="searchTerm"
                            (ionInput)="onSearchTermChange()"
                            placeholder="البحث في الأصناف..."
                            clearInput="true"
                            class="search-input">
                          </ion-input>
                          <div slot="end" class="search-navigation" *ngIf="searchMatches.length > 0">
                            <span class="search-results">{{ getSearchResultText() }}</span>
                            <ion-button fill="clear" size="small" (click)="navigateSearch('prev')">
                              <ion-icon name="chevron-up"></ion-icon>
                            </ion-button>
                            <ion-button fill="clear" size="small" (click)="navigateSearch('next')">
                              <ion-icon name="chevron-down"></ion-icon>
                            </ion-button>
                          </div>
                        </ion-item>
                      </div>
                    </ion-col>
                    <ion-col size="3" class="ion-text-end">
                      <ion-button 
                        fill="clear" 
                        color="light" 
                        size="small"
                        (click)="sortItemListAlphabetically()"
                        [disabled]="!itemList || itemList.length === 0"
                      >
                        <ion-icon name="list" slot="start"></ion-icon>
                        {{ isItemListSorted ? 'ترتيب أصلي' : 'ترتيب أبجدي' }}
                      </ion-button>
                      <ion-button 
                        fill="clear" 
                        color="light" 
                        size="small"
                        (click)="openPriceAdjustmentDialog()"
                        [disabled]="!itemList || itemList.length === 0"
                      >
                        <ion-icon name="pricetag" slot="start"></ion-icon>
                        تعديل الأسعار
                      </ion-button>
                    </ion-col>
                  </ion-row>
                </ion-card-title>
              </ion-card-header>
              <div class="table-container">
               <table class="table">
                 <tr>
                  <th>no</th>
                  <th>الصنف</th>
                  <th>الكمية</th>
                  <th>سعر الوحده</th>
                  <th>المجموع</th> 
                  <!-- <th></th>  -->
                 </tr>
                 <tr *ngFor="let item of getDisplayItemList() ; let i = index" 
                     (dblclick)="qtyClick(i)"
                     [attr.data-index]="i"
                     [class.search-highlight]="isHighlighted(i)"
                     [class.search-match]="isSearchMatch(i)">
                  <td>{{i+1}}</td>
                  <td>
                    <span [innerHTML]="highlightText(item.item_name, searchTerm)"></span>
                  </td>
                  <td>
                    <ion-text *ngIf="showMe != i">{{item.quantity}}</ion-text> 
                    <ion-item *ngIf="showMe == i">
                     <ion-input (keyup.enter)="editCell(i)" [(ngModel)] ="item.quantity" (ionBlur)="editCell(i)" ></ion-input>
                    </ion-item>
                 </td>
                 <td>
                   <ion-text *ngIf="showMe != i">{{item.pay_price}}</ion-text> 
                    <ion-item *ngIf="showMe == i">
                     <ion-input (keyup.enter)="editCell(i)" [(ngModel)] ="item.pay_price" (ionBlur)="editCell(i)" ></ion-input>
                    </ion-item>
                 </td>
                  <td>{{+item.tot}}</td>
                  <td>
                    <ion-button fill="clear" size="small" (click)="deleteItem(i)">
                      <ion-icon name="trash" color="danger" ></ion-icon>
                    </ion-button>
                  </td>
                   <!-- <td>
                    <ion-button fill="clear" size="small" (click)="emadFunction(item)">
                      <ion-icon name="edit" color="success" ></ion-icon>
                    </ion-button>
                  </td> -->
                 </tr>
                 
               
               </table>
              </div> 
            </ion-card>
          </ion-col>
          </ion-row>
        </ion-grid>
      </ion-col>
  
  
  
  
      <ion-col size="4" class="ion-no-padding">
        <ion-card>
          <ion-grid>
            <ion-row class="ion-justify-content-center">
              <ion-col size="11">
                <ion-label class="ion-padding"><strong>اجمالي المبلغ</strong></ion-label>
                <ion-item class="custInput"> 
                  <ion-input [(ngModel)]="payInvo.tot_pr" [readonly]="true"></ion-input>
                </ion-item>
              </ion-col>
               <ion-col size="11">
              <!-- Discount Section -->
              <ion-label class="ion-padding"><strong>  الخصم  </strong> </ion-label>
                <ion-item dir="rtl"> 
                  <ion-segment [(ngModel)]="discountType" (ionChange)="onDiscountTypeChange($event)" slot="start">
                    <ion-segment-button value="percentage">
                      <ion-label>نسبة %</ion-label>
                    </ion-segment-button>
                    <ion-segment-button value="amount">
                      <ion-label>مبلغ</ion-label>
                    </ion-segment-button>
                  </ion-segment>
                </ion-item>  
              <!-- Percentage Discount Input -->
              <ion-item *ngIf="discountType === 'percentage'" class="rtl-input" class="custInput">
                <ion-label position="floating" class="float-right">نسبة الخصم %</ion-label>
                <ion-input 
                  type="number" 
                  [(ngModel)]="discountPerc" 
                  (ionInput)="onPercentageDiscountChange($event)"
                  placeholder="نسبة الخصم %">
                </ion-input>
                <ion-note slot="end" *ngIf="calculatedDiscountAmount > 0">
                  {{ calculatedDiscountAmount.toFixed(2) }} 
                </ion-note>
              </ion-item>

              <!-- Amount Discount Input -->
              <ion-item *ngIf="discountType === 'amount'" class="rtl-input" class="custInput">
                <ion-label position="floating" class="float-right">مبلغ الخصم</ion-label>
                <ion-input 
                  type="number" 
                  [(ngModel)]="discountAmount" 
                  (ionInput)="onAmountDiscountChange($event)"
                   placeholder="مبلغ الخصم ">
                </ion-input>
                <ion-note slot="end" *ngIf="calculatedDiscountPerc > 0">
                  {{ calculatedDiscountPerc.toFixed(2) }}%
                </ion-note>
              </ion-item>
            </ion-col>

              <!-- <ion-col size="9">
                <ion-label class="ion-padding">
                  <strong>الخصم %</strong> 
                </ion-label>
  
                <ion-label class="ion-padding ion-margin-start">
                  <strong>الخصم</strong> 
                </ion-label> 
                <ion-item class="custInput"> 
                  <ion-input  [(ngModel)]="discountPerc" (ionChange)="discountPerChange($event)"></ion-input>
                  <ion-input  class="custInp" [(ngModel)]="payInvo.discount"  tabindex="600"  (ionBlur)="discountChange($event)"></ion-input> 
                </ion-item>
              </ion-col> -->
              <ion-col size="11">
                <ion-label class="ion-padding"><strong> المدفوع نقدا</strong></ion-label>
                <ion-item class="custInput"> 
                  <ion-input [(ngModel)]="payInvo.pay" (ionChange)="payChange($event)"></ion-input>
                </ion-item>
              </ion-col>
              <ion-col size="11">
                <ion-label class="ion-padding"><strong>المتبقي</strong></ion-label>
                <ion-item class="custInput"> 
                  <ion-input  [(ngModel)]="payInvo.changee" [readonly]="true"></ion-input>
                </ion-item>
              </ion-col>
              <ion-col size="11">
                <ion-label class="ion-padding"><strong>تاريخ السداد</strong></ion-label>
                <ion-item class="custInput"> 
                  <ion-item lines="none">
                    <input style="width:100%"  type="date"  id="startingDate6" name="startingDate6" [(ngModel)]="payInvo.nextPay"  />
                  </ion-item>
                </ion-item>
              </ion-col> 
            </ion-row>
            <ion-row class="ion-justify-content-center">
              <ion-col size="5" >
                <ion-button fill="outline" expand="block" routerDirection="root"  color="primary"  (click)="update()" >
                  <ion-label class="ion-text-center"> حفــظ</ion-label>
                </ion-button>
              </ion-col>
              <ion-col size="5" >
                <ion-button expand="block" routerDirection="root" color="danger"  (click)="delete()" >
                  <ion-label class="ion-text-center"> حــذف</ion-label>
                </ion-button>
              </ion-col>
            </ion-row>
          </ion-grid> 
        </ion-card>
      </ion-col>
      
    </ion-row>
  </ion-grid>

</ion-content>
