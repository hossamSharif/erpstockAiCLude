<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button (click)="back()" defaultHref="/"></ion-back-button>
    </ion-buttons>
    <ion-title>تعديل فاتورة مشتريات</ion-title>
    <!-- Date in header -->
    <ion-buttons slot="end">
      <app-currency-switcher></app-currency-switcher>
      <ion-item class="header-date-item">
        <ion-input type="date" [(ngModel)]="payInvo.pay_date" class="header-date-input"></ion-input>
      </ion-item>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content> 
    <ion-card class="ion-no-padding ion-no-margin"> 
      <ion-grid *ngIf="payInvo">
        <ion-row dir="rtl" class="top-card-row">
          <!-- First Column: Account Selector -->
          <ion-col size="4" offset="3" class="account-column">
            <app-account-selector
              accountType="supplier"
              placeholder="اختر حساب المورد"
              label="حساب المورد"
              [store_info]="store_info"
              [year]="year"
              [showAddButton]="true"
              [(ngModel)]="selectedAccount"
              (accountSelected)="onAccountSelected($event)"
              (balanceLoaded)="onAccountBalanceLoaded($event)">
            </app-account-selector>
          </ion-col>
          
          <!-- Comment Column: Note field in same row -->
          <ion-col size="4" class="date-comment-column">
            <ion-label class="column-label">ملاحظة</ion-label>
            <ion-item class="custInput comment-input"> 
              <ion-input placeholder="أكتب تعليقا" [(ngModel)]="payInvo.payComment" [disabled]="isLoading()"></ion-input>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card>
    <ion-grid  *ngIf="payInvo" >
      <ion-row dir="rtl" class="ion-justify-content-center">
        <ion-col size="11" class="ion-no-padding">
        <ion-grid>
          <ion-row>
            <ion-col size="12">
              <ion-card>
              <app-item-selector
                [items]="items"
                [loadingItems]="loadingItems"
                [searchLang]="searchLang"
                [store_info]="store_info"
                [year]="year"
                parentPage="edit-perch"
                [enablePriceUpdateConfirmation]="true"
                [payRef]="payInvo.pay_ref"
                [showQuantityInput]="true"
                [showPriceInput]="false"
                [showPerchPriceInput]="true"
                placeholder="اختر الصنف"
                (itemSelected)="onItemSelected($event)"
                (itemAdded)="onItemAdded($event)"
                (refreshItems)="refresh('item')">
              </app-item-selector>
              </ion-card>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size="12">
            <ion-card>
              <ion-card-header color="primary" class="table-card-header">
                <ion-card-title>
                  <ion-row class="ion-align-items-center">
                    <ion-col size="3">
                      <span>قائمة الأصناف</span>
                    </ion-col>
                    <ion-col size="6" class="ion-text-center">
                      <div class="search-container">
                        <ion-item lines="none" class="search-item">
                          <ion-icon name="search" slot="start" color="medium"></ion-icon>
                          <ion-input
                            [(ngModel)]="searchTerm"
                            (ionInput)="onSearchTermChange()"
                            placeholder="البحث في الأصناف..."
                            clearInput="true"
                            class="search-input">
                          </ion-input>
                          <div slot="end" class="search-navigation" *ngIf="searchMatches.length > 0">
                            <span class="search-results">{{ getSearchResultText() }}</span>
                            <ion-button fill="clear" size="small" (click)="navigateSearch('prev')">
                              <ion-icon name="chevron-up"></ion-icon>
                            </ion-button>
                            <ion-button fill="clear" size="small" (click)="navigateSearch('next')">
                              <ion-icon name="chevron-down"></ion-icon>
                            </ion-button>
                          </div>
                        </ion-item>
                      </div>
                    </ion-col>
                    <ion-col size="3" class="ion-text-end">
                      <ion-button 
                        fill="clear" 
                        color="light" 
                        size="small"
                        (click)="sortItemListAlphabetically()"
                        [disabled]="!itemList || itemList.length === 0"
                      >
                        <ion-icon name="list" slot="start"></ion-icon>
                        {{ isItemListSorted ? 'ترتيب أصلي' : 'ترتيب أبجدي' }}
                      </ion-button>
                      <ion-button 
                        fill="clear" 
                        color="light" 
                        size="small"
                        (click)="openPriceAdjustmentDialog()"
                        [disabled]="!itemList || itemList.length === 0"
                      >
                        <ion-icon name="pricetag" slot="start"></ion-icon>
                        تعديل الأسعار
                      </ion-button>
                    </ion-col>
                  </ion-row>
                </ion-card-title>
              </ion-card-header>
              <div class="table-container">
               <table class="table">
                 <tr>
                  <th>no</th>
                  <th>الصنف</th>
                  <th>الكمية</th>
                  <th>سعر الشراء ({{ getCurrencySymbol() }})</th>
                  <th>المجموع ({{ getCurrencySymbol() }})</th> 
                  <th></th> 
                 </tr>
                 <tr *ngFor="let item of getDisplayItemList() ; let i = index" 
                     (dblclick)="qtyClick(i)"
                     [attr.data-index]="i"
                     [class.search-highlight]="isHighlighted(i)"
                     [class.search-match]="isSearchMatch(i)">
                  <td>{{i+1}}</td>
                  <td>
                    <span [innerHTML]="highlightText(item.item_name, searchTerm)"></span>
                  </td>
                  <td >
                    <ion-text *ngIf="showMe != i">{{item.quantity}}</ion-text> 
                    <ion-item *ngIf="showMe == i">
                     <ion-input (keyup.enter)="editCell(i)" [(ngModel)] ="item.quantity" (ionBlur)="editCell(i)" ></ion-input>
                    </ion-item>
                 </td>
                 <td>
                   <ion-text *ngIf="showMe != i">{{item.perch_price | currencyDisplay:'SDG':false}}</ion-text> 
                    <ion-item *ngIf="showMe == i">
                     <ion-input (keyup.enter)="editCell(i)" [(ngModel)] ="item.perch_price" (ionBlur)="editCell(i)" ></ion-input>
                    </ion-item>
                 </td>
                  <td>{{item.tot | currencyDisplay:'SDG':false}}</td>
                  <td>
                    <ion-button fill="clear" size="small" (click)="deleteItem(i)">
                      <ion-icon name="trash" color="danger" ></ion-icon>
                    </ion-button>
                  </td>
                 </tr> 
               </table>
              </div> 
            </ion-card>
          </ion-col>
          </ion-row>
        </ion-grid>
      </ion-col> 
    </ion-row> 
  </ion-grid>

</ion-content>


<!-- Footer with totals and action buttons -->
<ion-footer>
  <ion-toolbar>
    <ion-grid class="ion-no-padding">
      <ion-row class="ion-align-items-center">
        <!-- Discount controls on the right side -->
        <ion-col size="8" class="ion-text-end">
          <ion-grid class="ion-no-padding">
            <ion-row class="ion-justify-content-end">
              <ion-col class="footer-input-container">
                <ion-label class="footer-input-label">إجمالي المبلغ</ion-label>
                <ion-item class="custInput footer-input-item">
                  <ion-input [value]="payInvo.tot_pr | currencyDisplay" [readonly]="true"></ion-input>
                </ion-item>
              </ion-col>
              <ion-col class="footer-input-container">
                <div class="discount-header"> 
                  <div dir="rtl" class="discount-segment-container"> 
                    <ion-segment [(ngModel)]="discountType" (ionChange)="onDiscountTypeChange($event)" class="compact-discount-segment" [disabled]="isLoading()">
                      <ion-segment-button value="percentage" class="compact-segment-button">
                        <ion-label>نسبة الخصم%</ion-label>
                      </ion-segment-button>
                      <ion-segment-button value="amount" class="compact-segment-button">
                        <ion-label>مبلغ الخصم</ion-label>
                      </ion-segment-button>
                    </ion-segment>
                  </div>
                </div>
                <!-- Percentage Discount Input -->
                <ion-item *ngIf="discountType === 'percentage'" class="rtl-input custInput discount-input">
                  <ion-input 
                    type="number" 
                    [(ngModel)]="discountPerc" 
                    (ionInput)="onPercentageDiscountChange($event)"
                    placeholder="نسبة الخصم %"
                    [disabled]="isLoading()">
                  </ion-input>
                  <ion-note slot="end" *ngIf="calculatedDiscountAmount > 0" class="discount-note">
                    {{ calculatedDiscountAmount | currencyDisplay }} 
                  </ion-note>
                </ion-item>

                <!-- Amount Discount Input -->
                <ion-item *ngIf="discountType === 'amount'" class="rtl-input custInput discount-input">
                  <ion-input 
                    type="number" 
                    [(ngModel)]="discountAmount" 
                    (ionInput)="onAmountDiscountChange($event)"
                     placeholder="مبلغ الخصم"
                     [disabled]="isLoading()">
                  </ion-input>
                  <ion-note slot="end" *ngIf="calculatedDiscountPerc > 0" class="discount-note">
                    {{ calculatedDiscountPerc.toFixed(2) }}%
                  </ion-note>
                </ion-item>
              </ion-col>
              <ion-col class="footer-input-container">
                <ion-label class="footer-input-label">المجموع بعد الخصم</ion-label>
                <ion-item class="custInput total-after-discount footer-input-item">
                  <ion-input [value]="(+payInvo.tot_pr - +payInvo.discount) | currencyDisplay" [readonly]="true"></ion-input>
                </ion-item>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-col>
        
        <!-- Action buttons on the left side -->
        <ion-col size="4">
          <ion-grid>
            <ion-row class="ion-justify-content-end">
              <ion-col size="6">
                <ion-button expand="block" routerDirection="root" color="success" (click)="update()" [disabled]="isLoading()">
                  <ion-spinner *ngIf="isUpdating" slot="start" name="dots"></ion-spinner>
                  <ion-label class="ion-text-center">{{ isUpdating ? currentLoadingMessage : 'حفظ' }}</ion-label>
                </ion-button>
              </ion-col>
              <ion-col size="6">
                <ion-button expand="block" routerDirection="root" color="danger" (click)="delete()" [disabled]="isLoading()">
                  <ion-spinner *ngIf="isDeleting" slot="start" name="dots"></ion-spinner>
                  <ion-label class="ion-text-center">{{ isDeleting ? currentLoadingMessage : 'حذف' }}</ion-label>
                </ion-button>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ion-toolbar>
</ion-footer>
