<ion-header class="transparent-header">
  <ion-toolbar class="transparent-toolbar">
    <ion-buttons slot="start">
      <ion-back-button *ngIf="hasParameter" defaultHref="/" class="glass-menu-button"></ion-back-button>
      <ion-menu-button *ngIf="!hasParameter" class="glass-menu-button"></ion-menu-button>
    </ion-buttons>
    <ion-title class="glass-title">تقرير حركة الصنف</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="refresh()">
        <ion-icon name="refresh-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="modern-content">
  <!-- Loading State -->
  <div *ngIf="!user_info || !store_info" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p class="loading-text">جاري التحميل...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="user_info && store_info" class="main-container">
    <div class="form-container">
      
      <!-- Item Selection and Search Card -->
      <ion-card class="form-card compact-card">
        <ion-card-content class="compact-content">
          <!-- Main Row: Item Selection and Search Type -->
          <div class="main-row">
            <!-- Item Selection -->
            <div class="item-section">
              <!-- <ion-label class="field-label">الصنف</ion-label> -->
              
              <!-- Enhanced Item Selector Component - simple field style -->
              <app-enhanced-item-selector
                [placeholder]="'اختر الصنف للتقرير'"
                [searchLang]="searchLang"
                [showQuantityDisplay]="false"
                [parentPage]="'items-report'"
                (itemSelected)="onItemSelected($event)"
                (refreshRequested)="onRefreshRequested()">
              </app-enhanced-item-selector>
            </div>

            <!-- Search Type -->
            <div class="search-type-section">
              <ion-label class="field-label">نوع البحث</ion-label>
              <ion-segment [(ngModel)]="radioVal" (ionChange)="radioChange($event)" class="compact-segment">
                <ion-segment-button value="0">
                  <span>جميع الحركات</span>
                </ion-segment-button>
                <ion-segment-button value="1">
                  <span>بحث في تاريخ محدد</span>
                </ion-segment-button>
                <ion-segment-button value="2">
                  <span>بحث في فترة زمنية</span>
                </ion-segment-button>
                <!-- <ion-segment-button value="3">
                  <span>الحركة اليومية</span>
                </ion-segment-button> -->
              </ion-segment>
            </div>
          </div>
          
          <!-- Search Row -->
          <div class="search-row">
            <!-- Date Inputs -->
            <ion-input 
              *ngIf="radioVal == 1 || radioVal == 3"
              type="date" 
              [(ngModel)]="startingDate"
              class="mini-input date-input">
            </ion-input>
            
            <ion-input 
              *ngIf="radioVal == 2"
              type="date" 
              [(ngModel)]="startingDate"
              placeholder="من تاريخ"
              class="mini-input date-input">
            </ion-input>
            
            <ion-input 
              *ngIf="radioVal == 2"
              type="date" 
              [(ngModel)]="endDate"
              placeholder="إلى تاريخ"
              class="mini-input date-input">
            </ion-input>
            
            <!-- Search Button -->
            <ion-button 
              (click)="search()"
              fill="outline"
              class="mini-btn search-btn">
              <ion-icon name="search-outline" slot="start"></ion-icon>
              بحث
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
      <!-- Item Info Card - 4 Columns -->
      <ion-card class="info-card" *ngIf="selectedItemNew && selectedItemNew.id && radioVal != 3">
        <ion-card-content class="info-content">
          <div class="info-grid">
            <!-- First Column: الكمية الإفتتاحية -->
            <div class="info-column">
              <div class="info-item">
                <span class="info-label">الكمية الإفتتاحية:</span>
                <span class="info-value">{{ selectedItemNew.firstQty }}</span>
              </div>
            </div>

            <!-- Second Column: الكمية الحالية -->
            <div class="info-column">
              <div class="info-item">
                <span class="info-label">الكمية الحالية:</span>
                <span class="info-value" [style.color]="selectedItemNew.availQty > 0 ? '#10dc60' : '#f04141'">
                  {{ selectedItemNew.availQty }}
                </span>
              </div>
            </div>

            <!-- Third Column: الكمية الصادرة -->
            <div class="info-column">
              <div class="info-item">
                <span class="info-label">الكمية الصادرة:</span>
                <span class="info-value">{{ selectedItemNew.payTotQty }}</span>
              </div>
            </div>

            <!-- Fourth Column: الكمية الواردة -->
            <div class="info-column">
              <div class="info-item">
                <span class="info-label">الكمية الواردة:</span>
                <span class="info-value">{{ selectedItemNew.perchTotQty }}</span>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Main Table -->
      <ion-card class="table-card" *ngIf="radioVal != 3" color="primary">
        <ion-card-header class="table-header">
          <ion-card-title class="table-title">
            <ion-icon name="list-outline" slot="start"></ion-icon>
            تقرير حركة الصنف - {{ selectedItemNew?.item_name || 'اختر صنف لعرض البيانات' }}
            <span class="transaction-count" *ngIf="payArray && payArray.length > 0">
              ({{ payArray.length }} حركة)
            </span>
          </ion-card-title>
        </ion-card-header>
        <ion-card-content class="table-content">
          <div class="table-container">
            <table class="modern-table">
              <thead>
                <tr>
                  <th>التسلسل</th>
                  <th class="sortable-header" (click)="sortTransactionsBy('type')">
                    <ion-icon [name]="getTransactionsSortIcon('type')" class="sort-icon"></ion-icon>
                    نوع الحركة
                  </th>
                  <th class="sortable-header" (click)="sortTransactionsBy('pay_date')">
                    <ion-icon [name]="getTransactionsSortIcon('pay_date')" class="sort-icon"></ion-icon>
                    التاريخ
                  </th>
                  <th class="sortable-header" (click)="sortTransactionsBy('quantity')">
                    <ion-icon [name]="getTransactionsSortIcon('quantity')" class="sort-icon"></ion-icon>
                    الكمية الواردة
                  </th>
                  <th class="sortable-header" (click)="sortTransactionsBy('quantity')">
                    <ion-icon [name]="getTransactionsSortIcon('quantity')" class="sort-icon"></ion-icon>
                    الكمية الصادرة
                  </th>
                  <th class="sortable-header" (click)="sortTransactionsBy('sub_name')">
                    <ion-icon [name]="getTransactionsSortIcon('sub_name')" class="sort-icon"></ion-icon>
                    العميل/المورد
                  </th>
                  <th class="sortable-header" (click)="sortTransactionsBy('pay_price')">
                    <ion-icon [name]="getTransactionsSortIcon('pay_price')" class="sort-icon"></ion-icon>
                    سعر البيع
                  </th>
                  <th class="sortable-header" (click)="sortTransactionsBy('perch_price')">
                    <ion-icon [name]="getTransactionsSortIcon('perch_price')" class="sort-icon"></ion-icon>
                    سعر الشراء
                  </th>
                  <th class="sortable-header" (click)="sortTransactionsBy('tot')">
                    <ion-icon [name]="getTransactionsSortIcon('tot')" class="sort-icon"></ion-icon>
                    المجموع
                  </th>
                  <th>عرض الفاتورة</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let pay of sortedPayArray; let i = index" class="table-row">
                  <td class="serial">{{ i + 1 }}</td>
                  <td class="type">
                    <span class="transaction-type" 
                          [ngClass]="{
                            'sales-type': pay.type === 'مبيعات', 
                            'purchase-type': pay.type === 'مشتريات', 
                            'voucher-type': pay.type === 'تسوية جردية'
                          }">
                      {{ pay.type }}
                    </span>
                  </td>
                  <td class="date">{{ pay.pay_date | date:'dd/MM/yyyy' }}</td>
                  <td class="debit">
                    <span *ngIf="pay.type == 'مشتريات' || (pay.type == 'تسوية جردية' && +pay.quantity < 0)" class="amount">
                      {{ toPositive(pay.quantity) }}
                    </span>
                  </td>
                  <td class="credit">
                    <span *ngIf="pay.type == 'مبيعات' || (pay.type == 'تسوية جردية' && +pay.quantity > 0)" class="amount">
                      {{ toPositive(pay.quantity) }}
                    </span>
                  </td>
                  <td class="details">
                    <span *ngIf="pay.type == 'مبيعات' || pay.type == 'مشتريات'">{{ pay.sub_name }}</span>
                  </td>
                  <td class="amount">{{ pay.pay_price }}</td>
                  <td class="amount">{{ pay.perch_price }}</td>
                  <td class="amount">{{ toPositive(+pay.tot) }}</td>
                  <td class="actions">
                    <ion-button fill="clear" size="small" (click)="getPayInvoDetail(pay, pay.sub_name, 'edit')">
                      <ion-icon name="eye-outline" color="primary"></ion-icon>
                    </ion-button>
                  </td>
                </tr>
                
                <!-- Loading Skeleton -->
                <tr *ngIf="loading" class="skeleton-row">
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                </tr>
                <tr *ngIf="loading" class="skeleton-row">
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Empty State -->
          <div class="empty-state" *ngIf="showEmpty && !loading">
            <ion-icon name="archive-outline" class="empty-icon"></ion-icon>
            <h4>لا توجد حركات</h4>
            <p>لم يتم العثور على حركات لهذا الصنف</p>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Daily Report Table -->
      <ion-card class="table-card" *ngIf="radioVal == 3" color="primary">
        <ion-card-header class="table-header">
          <ion-card-title class="table-title">
            <ion-icon name="calendar-outline" slot="start"></ion-icon>
            الحركة اليومية للأصناف
            <span class="transaction-count" *ngIf="payArrayDaily && payArrayDaily.length > 0">
              ({{ payArrayDaily.length }} صنف)
            </span>
          </ion-card-title>
        </ion-card-header>
        <ion-card-content class="table-content">
          <div class="table-container">
            <table class="modern-table">
              <thead>
                <tr>
                  <th>التسلسل</th>
                  <th>الصنف</th>
                  <th>نوع الحركة</th>
                  <th>الكمية الواردة</th>
                  <th>الكمية الصادرة</th>
                  <th>الكمية الحالية</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let pay of payArrayDaily; let i = index" class="table-row">
                  <td class="serial">{{ i + 1 }}</td>
                  <td class="details">{{ pay.item_name }}</td>
                  <td class="type">
                    <span class="transaction-type" 
                          [ngClass]="{
                            'sales-type': pay.type === 'مبيعات', 
                            'purchase-type': pay.type === 'مشتريات', 
                            'voucher-type': pay.type === 'تسوية جردية'
                          }">
                      {{ pay.type }}
                    </span>
                  </td>
                  <td class="debit">
                    <span *ngIf="pay.type == 'مشتريات' || (pay.type == 'تسوية جردية' && +pay.quantity < 0)" class="amount">
                      {{ toPositive(pay.quantity) }}
                    </span>
                  </td>
                  <td class="credit">
                    <span *ngIf="pay.type == 'مبيعات' || (pay.type == 'تسوية جردية' && +pay.quantity > 0)" class="amount">
                      {{ toPositive(pay.quantity) }}
                    </span>
                  </td>
                  <td class="amount">{{ pay.currenQty }}</td>
                </tr>
                
                <!-- Loading Skeleton -->
                <tr *ngIf="loading" class="skeleton-row">
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                  <td><ion-skeleton-text animated style="width: 100%"></ion-skeleton-text></td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Empty State -->
          <div class="empty-state" *ngIf="showEmpty && !loading">
            <ion-icon name="archive-outline" class="empty-icon"></ion-icon>
            <h4>لا توجد حركات</h4>
            <p>لم يتم العثور على حركات في هذا التاريخ</p>
          </div>
        </ion-card-content>
      </ion-card>
    </div>
  </div>
</ion-content>

<!-- Footer with Totals -->
<ion-footer class="totals-footer" *ngIf="selectedItemNew && selectedItemNew.id && radioVal != 3">
  <div class="totals-container">
    <div class="total-item">
      <div class="total-label">إجمالي الصادر:</div>
      <div class="total-value debit-total">{{ selectedItemNew.totSales }}</div>
    </div>
    <div class="total-item">
      <div class="total-label">إجمالي الوارد:</div>
      <div class="total-value credit-total">{{ selectedItemNew.totPurch }}</div>
    </div>
  </div>
</ion-footer>