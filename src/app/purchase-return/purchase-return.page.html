<ion-content>
  <ion-card>
    <div class="container">
      
      <!-- Header Section -->
      <div class="section-header">
        <ion-title>فاتورة مرتجعات الشراء</ion-title>
        <ion-button fill="clear" (click)="back()" *ngIf="showBackButton">
          <ion-icon name="arrow-back"></ion-icon>
        </ion-button>
      </div>

      <!-- Original Invoice Selection Section -->
      <div class="section">
        <ion-card>
          <ion-card-header>
            <ion-card-title class="section-title">اختيار فاتورة الشراء الأصلية</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="form-row">
              <ion-item>
                <ion-label position="stacked">الفاتورة المختارة</ion-label>
                <ion-input 
                  [value]="selectedOriginalInvoice?.pay_ref || ''" 
                  readonly="true"
                  placeholder="لم يتم اختيار فاتورة بعد">
                </ion-input>
              </ion-item>
              <ion-button 
                fill="outline" 
                (click)="loadAvailablePurchaseInvoices()"
                [disabled]="isLoading()">
                <ion-icon name="search" slot="start"></ion-icon>
                البحث في فواتير الشراء
              </ion-button>
            </div>

            <!-- Available Invoices List -->
            <div *ngIf="availablePurchaseInvoices.length > 0" class="invoices-list">
              <ion-list>
                <ion-radio-group [(ngModel)]="selectedOriginalInvoice">
                  <ion-item 
                    *ngFor="let invoice of availablePurchaseInvoices" 
                    (click)="selectOriginalInvoice(invoice)">
                    <ion-radio slot="start" [value]="invoice"></ion-radio>
                    <ion-label>
                      <div class="invoice-info">
                        <h3>{{ invoice.pay_ref }}</h3>
                        <p>{{ invoice.sub_name }} - {{ invoice.pay_date }}</p>
                        <p class="invoice-total">{{ formatBalance(invoice.tot_pr) }} {{ getCurrencySymbol() }}</p>
                      </div>
                    </ion-label>
                  </ion-item>
                </ion-radio-group>
              </ion-list>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Return All Items Toggle -->
      <div class="section" *ngIf="originalItems.length > 0">
        <ion-card>
          <ion-card-content>
            <ion-item>
              <ion-toggle 
                [(ngModel)]="isReturnAllItems" 
                (ionChange)="onReturnAllToggle()"
                color="primary">
              </ion-toggle>
              <ion-label class="toggle-label">
                <h2>إرجاع جميع الأصناف</h2>
                <p>تفعيل هذا الخيار سيقوم بإضافة جميع أصناف فاتورة الشراء الأصلية للإرجاع</p>
              </ion-label>
            </ion-item>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Account Selection Section -->
      <div class="section" *ngIf="selectedOriginalInvoice">
        <app-account-selector
          [accountType]="'supplier'"
          [preSelectedAccount]="selectedAccount"
          (accountSelected)="onAccountSelected($event)"
          (balanceLoaded)="onAccountBalanceLoaded($event)">
        </app-account-selector>
      </div>

      <!-- Item Selection Section -->
      <div class="section" *ngIf="!isReturnAllItems && originalItems.length > 0">
        <ion-card>
          <ion-card-header>
            <ion-card-title class="section-title">إضافة الأصناف للإرجاع</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <!-- Item Search -->
            <div class="form-row">
              <ion-item>
                <ion-label position="stacked">البحث عن الصنف</ion-label>
                <ion-input 
                  #dstPop 
                  [(ngModel)]="searchTerm" 
                  (ionInput)="pickDetail($event)"
                  (click)="presentPopover($event)"
                  placeholder="ابحث عن الصنف في فاتورة الشراء الأصلية">
                </ion-input>
              </ion-item>
              
              <ion-item>
                <ion-label position="stacked">الكمية</ion-label>
                <ion-input 
                  #qtyId 
                  type="number" 
                  [(ngModel)]="selectedItem.qty"
                  (ionInput)="qtyhange($event)"
                  placeholder="أدخل الكمية المراد إرجاعها">
                </ion-input>
              </ion-item>
              
              <ion-item>
                <ion-label position="stacked">السعر</ion-label>
                <ion-input 
                  type="number" 
                  [(ngModel)]="selectedItem.return_price"
                  (ionInput)="pricehange($event)"
                  placeholder="سعر الصنف">
                </ion-input>
              </ion-item>
              
              <ion-button 
                expand="block" 
                color="primary"
                (click)="addTolist()"
                [disabled]="!selectedItem.item_name || !selectedItem.qty">
                إضافة للقائمة
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Items List Section -->
      <div class="section" *ngIf="itemList.length > 0">
        <ion-card>
          <ion-card-header>
            <ion-card-title class="section-title">أصناف الإرجاع</ion-card-title>
            <div class="list-controls">
              <!-- Search in list -->
              <ion-item>
                <ion-input 
                  [(ngModel)]="searchTerm" 
                  (ionInput)="onSearchTermChange()"
                  placeholder="البحث في القائمة">
                </ion-input>
                <ion-button 
                  fill="clear" 
                  slot="end"
                  (click)="clearSearch()"
                  *ngIf="searchTerm">
                  <ion-icon name="close"></ion-icon>
                </ion-button>
              </ion-item>
              
              <!-- Sort button -->
              <ion-button 
                fill="clear" 
                (click)="sortItemListAlphabetically()">
                <ion-icon name="list"></ion-icon>
                ترتيب
              </ion-button>
            </div>
          </ion-card-header>
          
          <ion-card-content>
            <div class="table-container">
              <table class="items-table">
                <thead>
                  <tr>
                    <th>الصنف</th>
                    <th>الكمية</th>
                    <th>السعر ({{ getCurrencySymbol() }})</th>
                    <th>المجموع ({{ getCurrencySymbol() }})</th>
                    <th>عمليات</th>
                  </tr>
                </thead>
                <tbody>
                  <tr 
                    *ngFor="let item of getDisplayItemList(); let i = index" 
                    [attr.data-index]="i"
                    [class.highlighted]="isHighlighted(i)"
                    [class.search-match]="isSearchMatch(i)">
                    <td>
                      <div [innerHTML]="highlightText(item.item_name, searchTerm)"></div>
                    </td>
                    <td>
                      <ion-input 
                        type="number" 
                        [(ngModel)]="item.quantity"
                        (click)="qtyClick(i)"
                        (ionBlur)="editCell(i); hideMe(i)"
                        [readonly]="showMe !== i">
                      </ion-input>
                    </td>
                    <td>
                      <ion-input 
                        type="number" 
                        [(ngModel)]="item.return_price"
                        (click)="qtyClick(i)"
                        (ionBlur)="editCell(i); hideMe(i)"
                        [readonly]="showMe !== i">
                      </ion-input>
                    </td>
                    <td>{{ formatBalance(item.tot) }}</td>
                    <td>
                      <ion-button 
                        fill="clear" 
                        color="danger" 
                        (click)="deleteItem(i)">
                        <ion-icon name="trash"></ion-icon>
                      </ion-button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Search Navigation -->
            <div class="search-navigation" *ngIf="searchMatches.length > 0">
              <div class="search-results">{{ getSearchResultText() }}</div>
              <ion-button fill="clear" (click)="navigateSearch('prev')">
                <ion-icon name="chevron-up"></ion-icon>
              </ion-button>
              <ion-button fill="clear" (click)="navigateSearch('next')">
                <ion-icon name="chevron-down"></ion-icon>
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Discount Section -->
      <div class="section" *ngIf="itemList.length > 0">
        <ion-card>
          <ion-card-header>
            <ion-card-title class="section-title">تفاصيل الخصم والدفع</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <!-- Discount Type Selection -->
            <ion-item>
              <ion-label position="stacked">نوع الخصم</ion-label>
              <ion-select [(ngModel)]="discountType" (ionSelectionChange)="onDiscountTypeChange($event)">
                <ion-select-option value="percentage">نسبة مئوية</ion-select-option>
                <ion-select-option value="amount">مبلغ ثابت</ion-select-option>
              </ion-select>
            </ion-item>

            <!-- Percentage Discount -->
            <ion-item *ngIf="discountType === 'percentage'">
              <ion-label position="stacked">نسبة الخصم (%)</ion-label>
              <ion-input 
                type="number" 
                [(ngModel)]="discountPerc"
                (ionInput)="onPercentageDiscountChange($event)"
                placeholder="أدخل نسبة الخصم">
              </ion-input>
            </ion-item>

            <!-- Amount Discount -->
            <ion-item *ngIf="discountType === 'amount'">
              <ion-label position="stacked">مبلغ الخصم ({{ getCurrencySymbol() }})</ion-label>
              <ion-input 
                type="number" 
                [(ngModel)]="discountAmount"
                (ionInput)="onAmountDiscountChange($event)"
                placeholder="أدخل مبلغ الخصم">
              </ion-input>
            </ion-item>

            <!-- Payment Amount -->
            <ion-item>
              <ion-label position="stacked">المبلغ المدفوع ({{ getCurrencySymbol() }})</ion-label>
              <ion-input 
                type="number" 
                [(ngModel)]="returnInvo.pay"
                (ionInput)="payChange($event)"
                placeholder="أدخل المبلغ المدفوع">
              </ion-input>
            </ion-item>

            <!-- Return Reason -->
            <ion-item>
              <ion-label position="stacked">سبب الإرجاع</ion-label>
              <ion-textarea 
                [(ngModel)]="returnReason"
                rows="3"
                placeholder="أدخل سبب إرجاع الأصناف (اختياري للإرجاع الكامل)">
              </ion-textarea>
            </ion-item>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Summary Section -->
      <div class="section" *ngIf="itemList.length > 0">
        <ion-card>
          <ion-card-header>
            <ion-card-title class="section-title">ملخص فاتورة الإرجاع</ion-title>
          </ion-card-header>
          <ion-card-content>
            <div class="summary-grid">
              <div class="summary-row">
                <label>المجموع الفرعي:</label>
                <span>{{ formatBalance(itemList.reduce((acc, item) => acc + +item.tot, 0)) }} {{ getCurrencySymbol() }}</span>
              </div>
              
              <div class="summary-row" *ngIf="discountType === 'percentage' && discountPerc > 0">
                <label>الخصم ({{ discountPerc }}%):</label>
                <span>{{ formatBalance(calculatedDiscountAmount) }} {{ getCurrencySymbol() }}</span>
              </div>
              
              <div class="summary-row" *ngIf="discountType === 'amount' && discountAmount > 0">
                <label>الخصم:</label>
                <span>{{ formatBalance(discountAmount) }} {{ getCurrencySymbol() }}</span>
              </div>
              
              <div class="summary-row total-row">
                <label>المجموع النهائي:</label>
                <span>{{ formatBalance(returnInvo.tot_pr) }} {{ getCurrencySymbol() }}</span>
              </div>
              
              <div class="summary-row">
                <label>المبلغ المدفوع:</label>
                <span>{{ formatBalance(returnInvo.pay) }} {{ getCurrencySymbol() }}</span>
              </div>
              
              <div class="summary-row">
                <label>الباقي:</label>
                <span [class.negative]="returnInvo.changee < 0">{{ formatBalance(returnInvo.changee) }} {{ getCurrencySymbol() }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Action Buttons -->
      <div class="section" *ngIf="itemList.length > 0">
        <div class="action-buttons">
          <ion-button 
            expand="block" 
            color="primary"
            (click)="save()"
            [disabled]="isLoading()">
            <ion-icon name="save" slot="start"></ion-icon>
            حفظ فاتورة الإرجاع
          </ion-button>
        </div>
      </div>

    </div>
  </ion-card>

  <!-- Item Selection Popover -->
  <ion-popover #popover trigger="open-popover" [isOpen]="isOpen" (didDismiss)="didDissmis()">
    <ng-template>
      <ion-content>
        <ion-searchbar 
          #popInput 
          (ionInput)="searchItem($event)" 
          placeholder="ابحث عن الصنف">
        </ion-searchbar>
        <ion-list>
          <ion-item 
            *ngFor="let item of searchResult" 
            (click)="selectFromPop(item)">
            <ion-label>
              <h2>{{ item.item_name }}</h2>
              <p>{{ item.item_desc }}</p>
              <p>الكمية المتاحة: {{ item.quantity }}</p>
              <p>السعر: {{ formatBalance(item.perch_price) }} {{ getCurrencySymbol() }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-content>
    </ng-template>
  </ion-popover>

  <!-- Loading Indicator -->
  <div class="loading-overlay" *ngIf="isLoading()">
    <ion-spinner name="bubbles"></ion-spinner>
    <p>{{ currentLoadingMessage }}</p>
  </div>

</ion-content>